<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blood / Organ Donor Connect</title>
  <style>
    :root{--accent:#c62828;--muted:#666;--bg:#f7f7fb}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:var(--bg); color:#111}
    header{background:white; box-shadow:0 2px 6px rgba(20,20,30,0.06); padding:14px 20px; display:flex; align-items:center; justify-content:space-between}
    header h1{font-size:18px; margin:0; color:var(--accent)}
    nav{display:flex; gap:8px}
    .btn{background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer}
    .container{max-width:980px; margin:26px auto; padding:18px}
    .grid{display:grid; grid-template-columns:1fr 380px; gap:18px}
    .card{background:white; padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(60,60,80,0.05)}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #e6e6ef; font-size:14px}
    .small{font-size:13px; color:var(--muted)}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .donor-list{max-height:360px; overflow:auto}
    .donor-item{padding:10px;border-radius:8px;border:1px solid #f0f0f6;margin-bottom:10px}
    footer{padding:24px;text-align:center;color:var(--muted)}
    @media (max-width:900px){.grid{grid-template-columns:1fr} .container{padding:12px}}
  </style>
</head>
<body>
  <header>
    <h1>Blood / Organ Donor Connect</h1>
    <nav>
      <button class="btn" onclick="scrollToSection('register')">Register as Donor</button>
      <button class="btn" onclick="scrollToSection('request')">Raise Request</button>
    </nav>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card" id="mainPanel">
        <h2>Quick Actions</h2>
        <p class="small">Use this prototype UI to register donors, raise patient requests and test local matching logic. The app is single-file front-end — backend endpoints are shown as comments for real deployment.</p>

        <hr />

        <div style="display:flex; gap:10px; margin-bottom:12px">
          <button class="btn" onclick="openMapDemo()">Open Map (demo)</button>
          <button class="btn" onclick="loadSampleDonors()">Load Sample Donors</button>
        </div>

        <h3 id="statusTitle">Recent Requests</h3>
        <div id="requests" class="donor-list">
          <!-- requests will appear here -->
        </div>

      </section>

      <aside class="card">
        <h3>Nearby Matches</h3>
        <div id="matches" class="donor-list">
          <p class="small">No matches yet — raise a request to see algorithm in action.</p>
        </div>
        <hr />
        <h4>How it works — front-end demo</h4>
        <ol class="small">
          <li>Donors register with blood type, organs willing to donate & location.</li>
          <li>Patient raises request specifying blood type / organ + urgency.</li>
          <li>Client-side matching filters donors by compatibility and distance (uses geolocation lat/lon).</li>
          <li>In production the backend will notify donors and let hospitals verify donors.</li>
        </ol>
      </aside>
    </div>

    <section class="card" id="register" style="margin-top:18px">
      <h2>Register as Donor</h2>
      <form id="donorForm">
        <div class="row">
          <div>
            <label>Full name</label>
            <input type="text" id="d_name" required />
          </div>
          <div>
            <label>Phone / WhatsApp</label>
            <input type="text" id="d_phone" required />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Blood Type</label>
            <select id="d_blood">
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
            </select>
          </div>
          <div>
            <label>Organs willing to donate (comma separated)</label>
            <input id="d_organs" placeholder="blood, kidney, liver" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Location (auto-detect or paste lat,lon)</label>
          <div class="row">
            <input id="d_location" placeholder="e.g. 17.3850,78.4867" />
            <button type="button" class="btn" onclick="geoFind('d_location')">Use my location</button>
          </div>
          <p class="small">We store only coarse lat/lon for matching. In production use encrypted storage and hospital verification.</p>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px">
          <button class="btn" type="button" onclick="registerDonor()">Register</button>
          <button type="reset" class="btn" style="background:#555">Reset</button>
        </div>
      </form>
    </section>

    <section class="card" id="request" style="margin-top:18px">
      <h2>Raise Patient Request</h2>
      <form id="requestForm">
        <div class="row">
          <div>
            <label>Patient name</label>
            <input id="p_name" required />
          </div>
          <div>
            <label>Contact phone</label>
            <input id="p_phone" required />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Need (blood / organ)</label>
            <select id="p_need">
              <option value="blood">Blood</option>
              <option value="organ">Organ</option>
            </select>
          </div>
          <div>
            <label>Required blood type / organ</label>
            <input id="p_item" placeholder="A+  or kidney" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Urgency</label>
          <select id="p_urgency">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>

        <div style="margin-top:10px">
          <label>Location (paste lat,lon or use geolocation)</label>
          <div class="row">
            <input id="p_location" placeholder="e.g. 17.3850,78.4867" />
            <button type="button" class="btn" onclick="geoFind('p_location')">Use my location</button>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px">
          <button class="btn" type="button" onclick="raiseRequest()">Raise Request</button>
          <button type="reset" class="btn" style="background:#555">Reset</button>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top:18px">
      <h2>Donor Directory (for testing)</h2>
      <div id="donorDirectory" class="donor-list">
        <p class="small">No donors yet. Click "Load Sample Donors" or register above.</p>
      </div>
    </section>

    <footer class="card" style="margin-top:18px">
      <small>Prototype / demo only — not for production. For production: implement hospital authentication, server-side matching, auditing, encrypted storage, verification workflows, consent, regulatory compliance, and medical safety checks.</small>
    </footer>
  </main>

  <script>
    // Simple in-memory store for demo. Replace with backend endpoints for real app.
    const store = { donors: [], requests: [] };

    function scrollToSection(id){document.getElementById(id).scrollIntoView({behavior:'smooth'})}

    function geoFind(fieldId){
      if(!navigator.geolocation){alert('Geolocation not supported'); return}
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6)
        document.getElementById(fieldId).value = `${lat},${lon}`
      }, err => {alert('Could not get location: '+err.message)})
    }

    function parseLatLon(text){
      if(!text) return null
      const parts = text.split(',').map(s=>s.trim())
      if(parts.length<2) return null
      const lat = parseFloat(parts[0]), lon = parseFloat(parts[1])
      if(Number.isFinite(lat) && Number.isFinite(lon)) return {lat,lon}
      return null
    }

    function haversine(a,b){ // km
      const R = 6371
      const toRad = x=>x*Math.PI/180
      const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lon-a.lon)
      const A = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2
      return 2*R*Math.asin(Math.sqrt(A))
    }

    function registerDonor(){
      const name = document.getElementById('d_name').value.trim()
      const phone = document.getElementById('d_phone').value.trim()
      const blood = document.getElementById('d_blood').value
      const organs = document.getElementById('d_organs').value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean)
      const loc = parseLatLon(document.getElementById('d_location').value)
      if(!name||!phone||!loc){alert('Please fill name, phone and location (use geolocation)'); return}
      const donor = {id:Date.now().toString(36), name, phone, blood, organs, loc, verified:false, lastSeen: new Date().toISOString()}
      // In production: POST /api/donors with auth token; server validates phone/hospital verification
      store.donors.push(donor)
      renderDonors()
      alert('Registered donor (demo). In production this will notify hospitals for verification.')
    }

    function raiseRequest(){
      const p_name = document.getElementById('p_name').value.trim()
      const p_phone = document.getElementById('p_phone').value.trim()
      const need = document.getElementById('p_need').value
      const item = document.getElementById('p_item').value.trim()
      const urgency = document.getElementById('p_urgency').value
      const loc = parseLatLon(document.getElementById('p_location').value)
      if(!p_name||!p_phone||!item||!loc){alert('Please fill required fields and location'); return}
      const req = {id:Date.now().toString(36), p_name, p_phone, need, item, urgency, loc, created:new Date().toISOString()}
      store.requests.unshift(req)
      renderRequests()
      // run matching
      const matches = matchDonors(req)
      renderMatches(matches)
      // In production: POST /api/requests -> backend notifies donors and hospitals
      alert('Request raised (demo). Matching done locally (front-end).')
    }

    function matchDonors(req){
      // Basic compatibility rules: for blood match exact blood type (or O- universal) — this is simplified.
      // For organ: check organs list contains requested organ.
      const results = []
      for(const d of store.donors){
        try{
          const dist = haversine(req.loc, d.loc)
          let compatible = false
          if(req.need==='blood'){
            const r = req.item.toUpperCase()
            // Simplified: exact match OR donor is O- (universal) or recipient AB+ accepts any.
            if(d.blood===r || d.blood==='O-' || r==='AB+') compatible = true
          } else {
            const organ = req.item.toLowerCase()
            if(d.organs.map(x=>x.toLowerCase()).includes(organ)) compatible = true
          }
          if(compatible && dist<50) { // within 50 km for demo
            results.push({...d, distance:dist.toFixed(1)})
          }
        }catch(e){continue}
      }
      // sort by distance then lastSeen
      results.sort((a,b)=>parseFloat(a.distance)-parseFloat(b.distance))
      return results
    }

    function renderDonors(){
      const el = document.getElementById('donorDirectory')
      if(!store.donors.length){el.innerHTML='<p class="small">No donors yet.</p>'; return}
      el.innerHTML = store.donors.map(d=>`<div class="donor-item"><strong>${d.name}</strong> — ${d.blood} <br/><span class="small">Organs: ${d.organs.join(', ') || 'blood only'}</span><br/><span class="small">Loc: ${d.loc.lat.toFixed(4)}, ${d.loc.lon.toFixed(4)}</span></div>`).join('')
    }

    function renderRequests(){
      const el = document.getElementById('requests')
      if(!store.requests.length){el.innerHTML='<p class="small">No requests.</p>'; return}
      el.innerHTML = store.requests.map(r=>`<div class="donor-item"><strong>${r.p_name}</strong> needs <strong>${r.item}</strong> (${r.need}) — <span class="small">${r.urgency}</span><br/><span class="small">Location: ${r.loc.lat.toFixed(4)}, ${r.loc.lon.toFixed(4)}</span></div>`).join('')
    }

    function renderMatches(matches){
      const el = document.getElementById('matches')
      if(!matches.length){el.innerHTML='<p class="small">No matching donors within 50 km.</p>'; return}
      el.innerHTML = matches.map(m=>`<div class="donor-item"><strong>${m.name}</strong> — ${m.blood}<br/><span class="small">Distance: ${m.distance} km</span><br/><button class="btn" onclick='contactDonor("${m.id}")'>Contact</button></div>`).join('')
    }

    function contactDonor(id){
      const d = store.donors.find(x=>x.id===id)
      if(!d) return alert('Donor not found')
      // In production: this triggers secure messaging / phone call / masked number via backend
      alert(`Contact donor:\n${d.name}\nPhone: ${d.phone}\nPlease follow hospital verification procedures.`)
    }

    function loadSampleDonors(){
      // sample donors around Hyderabad (demo coords). In production data comes from DB
      store.donors = [
        {id:'d1', name:'Ravi Kumar', phone:'+919876543210', blood:'A+', organs:['blood'], loc:{lat:17.4401, lon:78.3489}, verified:true},
        {id:'d2', name:'Anita Shah', phone:'+919812345678', blood:'O-', organs:['blood','kidney'], loc:{lat:17.3850, lon:78.4867}, verified:true},
        {id:'d3', name:'Mohammed Ali', phone:'+919900112233', blood:'B+', organs:['blood','liver'], loc:{lat:17.3200, lon:78.5000}, verified:false}
      ];
      renderDonors()
      alert('Sample donors loaded')
    }

    function openMapDemo(){
      alert('Map demo: In production integrate with Google Maps / Mapbox using donor lat/lon. This demo does not load external map APIs.')
    }

    // initial render
    renderDonors(); renderRequests();

    // -- Notes for backend implementers (copy these into your server README) --
    /*
      Recommended backend endpoints (Flask / FastAPI / Django):

      POST /api/donors  -> register donor (verify phone/hospital)
      GET  /api/donors  -> list donors (with query params: lat, lon, radius, blood, organ)
      POST /api/requests -> create patient request (triggers matching + notifications)
      GET /api/requests  -> list open requests (hospital auth required)
      POST /api/hospitals/verify -> hospital verifies donor or schedules donation

      Security & compliance notes:
      - Use TLS, authenticated hospital accounts, phone / email OTP for donors.
      - Store personally identifying info encrypted at rest and only return masked contact details unless verified.
      - Add audit logging, consent flows, medical screening status, and legal disclaimers.
    */
  </script>
</body>
</html>
